// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

// =====================================
// USERS & AUTH
// =====================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String  
  role      UserRole
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  sessions          Session[]
  appointments      Appointment[] @relation("DoctorAppointments")
  auditLogs         AuditLog[]
  createdInvoices   Invoice[]     @relation("CreatedByUser")

  @@map("users")
}

enum UserRole {
  ADMIN
  DOCTOR
  RECEPTIONIST
  HYGIENIST
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  createdAt    DateTime @default(now())

  @@map("sessions")
}

// =====================================
// PATIENTS
// =====================================

model Patient {
  id            String    @id @default(cuid())
  patientNumber String    @unique // Auto-generado P-0001, P-0002
  firstName     String
  lastName      String
  dni           String?   @unique
  birthDate     DateTime?
  phone         String?
  mobile        String
  email         String?
  address       String?

  // Información médica
  allergies     String    
  diseases      String    
  medications   String    

  // Preferencias
  communicationPreference String? // EMAIL, WHATSAPP, SMS
  
  // LOPD
  lopdSigned    Boolean   @default(false)
  lopdDate      DateTime?

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  appointments  Appointment[]
  medicalHistory MedicalHistory[]
  invoices      Invoice[]
  whatsappMessages WhatsAppMessage[]

  @@map("patients")
}

// =====================================
// APPOINTMENTS
// =====================================

model Appointment {
  id          String            @id @default(cuid())
  patientId   String
  patient     Patient           @relation(fields: [patientId], references: [id])
  doctorId    String
  doctor      User              @relation("DoctorAppointments", fields: [doctorId], references: [id])
  
  startTime   DateTime
  endTime     DateTime
  
  treatment   String
  status      AppointmentStatus @default(SCHEDULED)
  notes       String?           
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relaciones
  reminders   Reminder[]

  @@index([patientId])
  @@index([doctorId])
  @@index([startTime])
  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Reminder {
  id            String   @id @default(cuid())
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  
  type          ReminderType
  sentAt        DateTime?
  status        ReminderStatus @default(PENDING)
  
  createdAt     DateTime @default(now())

  @@map("reminders")
}

enum ReminderType {
  EMAIL
  WHATSAPP
  SMS
}

enum ReminderStatus {
  PENDING
  SENT
  FAILED
}

// =====================================
// MEDICAL HISTORY
// =====================================

model MedicalHistory {
  id          String   @id @default(cuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
  
  // Odontograma (stored as JSON)
  odontogram  Json?
  
  // Tratamientos
  treatments  Treatment[]
  
  // Fotos
  photos     HistoryPhoto[]
  
  // Alertas
  alerts     MedicalAlert[]
  
  // Documentos firmados
  documents  SignedDocument[]
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("medical_histories")
}

model Treatment {
  id               String          @id @default(cuid())
  medicalHistoryId String
  medicalHistory   MedicalHistory  @relation(fields: [medicalHistoryId], references: [id])
  
  name             String
  description      String          
  status           TreatmentStatus @default(PLANNED)
  startDate        DateTime?
  endDate          DateTime?
  cost             Decimal         
  
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@map("treatments")
}

enum TreatmentStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model HistoryPhoto {
  id               String         @id @default(cuid())
  medicalHistoryId String
  medicalHistory   MedicalHistory @relation(fields: [medicalHistoryId], references: [id])
  
  url              String
  description      String?
  uploadedAt       DateTime       @default(now())

  @@map("history_photos")
}

model MedicalAlert {
  id               String          @id @default(cuid())
  medicalHistoryId String
  medicalHistory   MedicalHistory  @relation(fields: [medicalHistoryId], references: [id])
  
  type             AlertType
  message          String          
  severity         AlertSeverity   @default(MEDIUM)
  resolved         Boolean         @default(false)
  
  createdAt        DateTime        @default(now())

  @@map("medical_alerts")
}

enum AlertType {
  ALLERGY
  MEDICATION_INTERACTION
  TREATMENT_WARNING
  GENERAL
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model SignedDocument {
  id               String         @id @default(cuid())
  medicalHistoryId String
  medicalHistory   MedicalHistory @relation(fields: [medicalHistoryId], references: [id])
  
  type             DocumentType
  name             String
  url              String
  signedAt         DateTime?
  signature        String?        // Base64 signature
  isSigned         Boolean        @default(false)
  
  createdAt        DateTime       @default(now())

  @@map("signed_documents")
}

enum DocumentType {
  LOPD
  INFORMED_CONSENT
  TREATMENT_PLAN
  AUTHORIZATION
  OTHER
}

// =====================================
// INVOICES
// =====================================

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique // AAAA-NNNN
  series          String        @default("A")
  
  patientId       String
  patient         Patient       @relation(fields: [patientId], references: [id])
  
  issueDate       DateTime      @default(now())
  dueDate         DateTime?
  
  // Líneas de factura
  items           InvoiceItem[]
  
  // Totales
  subtotal        Decimal       
  vat             Decimal       
  total           Decimal       
  
  // VeriFactu
  qrData          String?
  hash            String?
  signatureDate   DateTime?
  
  // Estado
  status          InvoiceStatus @default(DRAFT)
  paidAt          DateTime?
  paymentMethod   String?
  
  // AEAT
  sentToAEAT      Boolean       @default(false)
  aeatReference   String?
  aeatSentAt      DateTime?
  
  // Relaciones
  createdById     String
  createdBy       User          @relation("CreatedByUser", fields: [createdById], references: [id])
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([patientId])
  @@index([invoiceNumber])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  CANCELLED
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description String
  quantity    Int
  unitPrice   Decimal 
  vat         Decimal  // Porcentaje IVA
  total       Decimal 

  @@map("invoice_items")
}

// =====================================
// WHATSAPP
// =====================================

model WhatsAppMessage {
  id            String        @id @default(cuid())
  patientId     String?
  patient       Patient?      @relation(fields: [patientId], references: [id])
  
  from          String
  to            String
  body          String        
  
  isUrgent      Boolean       @default(false)
  urgencyReason String?       
  
  status        MessageStatus @default(PENDING)
  sentAt        DateTime      @default(now())
  readAt        DateTime?
  
  createdAt     DateTime      @default(now())

  @@index([patientId])
  @@map("whatsapp_messages")
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

// =====================================
// IA - TEMPLATES & AUTOMATIONS
// =====================================

model Template {
  id          String         @id @default(cuid())
  name        String
  type        TemplateType
  content     String          // Con variables {{name}}, {{date}}
  isActive    Boolean        @default(true)
  
  automations Automation[]
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("templates")
}

enum TemplateType {
  WHATSAPP
  EMAIL
  SMS
  DOCUMENT
}

model Automation {
  id          String             @id @default(cuid())
  name        String
  trigger     AutomationTrigger
  
  templateId  String
  template    Template           @relation(fields: [templateId], references: [id])
  
  active      Boolean            @default(true)
  conditions  Json?              // Flow logic
  
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@map("automations")
}

enum AutomationTrigger {
  APPOINTMENT_24H_BEFORE
  APPOINTMENT_CONFIRMED
  APPOINTMENT_CANCELLED
  FIRST_VISIT
  CUSTOM
}

// =====================================
// CONFIGURATION
// =====================================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   
  group     String   // clinic, ai, whatsapp, etc.
  
  updatedAt DateTime @updatedAt

  @@map("settings")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  action    String
  entity    String   // Patient, Appointment, Invoice, etc.
  entityId  String
  changes   Json?    // Cambios realizados
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@map("audit_logs")
}

// =====================================
// MASTER TABLES
// =====================================

model DoctorSchedule {
  id        String   @id @default(cuid())
  doctorId  String
  dayOfWeek Int      // 0=Sunday, 1=Monday, etc.
  startTime String   // "10:00"
  endTime   String   // "14:00"
  isActive  Boolean  @default(true)
  
  @@map("doctor_schedules")
}

model TreatmentPrice {
  id          String  @id @default(cuid())
  name        String
  description String?
  price       Decimal 
  isActive    Boolean @default(true)
  
  @@map("treatment_prices")
}

model PaymentMethod {
  id       String  @id @default(cuid())
  name     String  @unique
  isActive Boolean @default(true)
  
  @@map("payment_methods")
}
